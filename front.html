<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票分析工具 - 高级科技界面</title>
    <!-- 引入Chart.js用于绘制折线图 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入Inter字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 全局样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', '思源黑体', sans-serif;
        }
        
        /* 浅色背景 */
        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        @keyframes particleFloat {
            0% { background-position: 0 0; }
            100% { background-position: 1000px 1000px; }
        }
        
        /* 主容器 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* 标题样式 */
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h1::before {
            content: '📈';
            font-size: 1.8rem;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            letter-spacing: 0.03em;
            position: relative;
            padding-bottom: 10px;
        }
        
        h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, #38b2ff, transparent);
        }
        
        /* 描述文字 */
        p {
            color: #7f8c8d;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 30px;
            letter-spacing: 0.02em;
        }
        
        /* 输入区域 */
        .input-section {
            /* display: flex; */
            gap: 20px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 500;
            color: #34495e;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        /* 输入框样式 */
        input {
            padding: 12px 16px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease-in-out;
        }
        
        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            transform: translateY(-1px);
        }
        
        input::placeholder {
            color: #bdc3c7;
        }
        
        /* 按钮样式 */
        button {
            margin-top: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(56, 182, 255, 0.4);
            background: linear-gradient(135deg, #42a5f5, #1976d2);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px -5px rgba(56, 182, 255, 0.4);
            animation: buttonTap 0.1s ease-in-out;
        }
        
        @keyframes buttonTap {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.95); }
        }
        
        /* 进度提示 */
        .progress {
            margin: 20px 0;
            color: #3498db;
            font-style: italic;
            font-size: 0.95rem;
            letter-spacing: 0.02em;
        }
        
        /* 图表区域 */
        .chart-section {
            margin: 40px 0;
            height: 400px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .chart-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.3), transparent);
        }
        
        /* 评论区域 */
        .comment-section {
            margin-top: 40px;
        }
        
        #comment {
            width: 100%;
            min-height: 140px;
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            color: #333;
            resize: vertical;
            font-family: 'Inter', '思源黑体', sans-serif;
            line-height: 1.6;
            letter-spacing: 0.01em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        /* 智能体进度卡片区域 */
        .agents-section {
            margin: 40px 0;
        }
        
        .agents-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 15px 0;
            scrollbar-width: auto;
            scrollbar-color: #3498db #ecf0f1;
        }
        
        /* 智能体结果显示区域 */
        .agent-result {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            color: #555;
            min-height: 40px;
            display: flex;
            align-items: center;
            word-break: break-word;
            line-height: 1.4;
        }
        /* 智能体结果有内容时的样式*/
        .agent-result.has-content {
            background-color: #e3f2fd;
            border-left: 3px solid #3498db;
        }
        
        /* Webkit浏览器自定义滚动条 */
        .agents-container::-webkit-scrollbar {
            height: 16px;
        }
        
        .agents-container::-webkit-scrollbar-track {
            background: #ecf0f1;
            border-radius: 4px;
        }
        
        .agents-container::-webkit-scrollbar-thumb {
            background-color: #3498db;
            border-radius: 4px;
            border: 2px solid #ecf0f1;
        }
        
        .agents-container::-webkit-scrollbar-thumb:hover {
            background-color: #2980b9;
        }
        
        /* 智能体卡片 */
        .agent-card {
            flex: 1;
            min-width: 220px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.3), transparent);
        }
        
        .agent-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px -10px rgba(52, 152, 219, 0.2);
            border-color: rgba(52, 152, 219, 0.3);
        }
        
        .agent-card.expanded {
            min-width: 350px;
            box-shadow: 0 15px 40px -10px rgba(52, 152, 219, 0.3);
            border-color: rgba(52, 152, 219, 0.4);
        }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .agent-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
            letter-spacing: 0.03em;
        }
        
        /* 状态标签 */
        .agent-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background-color: rgba(52, 152, 219, 0.1);
            color: #3498db;
            font-weight: 500;
            transition: all 0.3s ease-in-out;
        }
        
        .agent-status.running {
            background-color: rgba(243, 156, 18, 0.1);
            color: #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.2);
        }
        
        .agent-status.completed {
            background-color: rgba(39, 174, 96, 0.1);
            color: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.2);
        }
        
        .agent-status.failed {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.2);
        }
        
        /* 进度条 */
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.5s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* 智能体日志 */
        .agent-log {
            margin-top: 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: #555;
            background: #f8f9fa;
            padding: 0;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .agent-log.expanded {
            max-height: 300px;
            padding: 15px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 3px 0;
            border-bottom: 1px solid #e0e0e0;
            line-height: 1.5;
        }
        
        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .log-entry.timestamp {
            color: #95a5a6;
            font-size: 12px;
            margin-right: 8px;
        }
        
        /* 错误状态样式 */
        .error {
            border-color: rgba(231, 76, 60, 0.5) !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1) !important;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            animation: errorShake 0.5s ease-in-out;
        }
        
        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .chart-section {
                height: 300px;
                padding: 15px;
            }
            
            .agent-card {
                min-width: 280px;
            }
            
            .agent-card.expanded {
                min-width: 280px;
            }
        }
        
        /* 加载状态动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>股票分析工具</h1>
        <p>输入股票代码和时间范围，获取股价折线图及分析评论</p>

        <!-- 输入区域 -->
        <div class="input-section">
            <div class="form-group full-width">
                <label for="userInput">输入文本段落</label>
                <textarea id="userInput" rows="6" placeholder="请输入您想要分析的文本段落..."></textarea>
            </div>
            <button onclick="generateResult()" type="button">开始分析</button>
        </div>

        <!-- 进度提示 -->
        <div class="progress" id="progress"></div>

        <!-- 智能体进度卡片区域 -->
        <div class="agents-section">
            <h2>智能体执行状态</h2>
            <div class="agents-container">
                <div class="agent-card" id="taskAgentCard">
                    <div class="agent-header">
                        <span class="agent-title">任务解析智能体</span>
                    </div>
                    <div class="agent-result" id="taskAgentResult"></div>
                </div>
                <div class="agent-card" id="searchAgentCard" >
                    <div class="agent-header">
                        <span class="agent-title">搜索智能体</span>
                    </div>
                    <div class="agent-result" id="searchAgentResult"></div>
                </div>
                <div class="agent-card" id="chartAgentCard" >
                    <div class="agent-header">
                        <span class="agent-title">制图智能体</span>
                    </div>
                    <div class="agent-result" id="chartAgentResult"></div>
                </div>
                <div class="agent-card" id="commentAgentCard" >
                    <div class="agent-header">
                        <span class="agent-title">评论智能体</span>
                    </div>
                    <div class="agent-result" id="commentAgentResult"></div>
                </div>

            </div>
        </div>

        <!-- 折线图区域
        <div class="chart-section">
            <img id="stockChart" alt="股票图表" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
        </div> -->

        <!-- 评论区域 -->
        <div class="comment-section">
            <h2>智能体分析评论</h2>
            <textarea id="comment" readonly placeholder="分析结果将显示在这里..."></textarea>
        </div>
    </div>

    <script>

        // 更新智能体状态和结果
        function updateAgentStatus(agentName, status, result, log) {
            const statusEl = document.getElementById(`${agentName}Status`);
            const resultEl = document.getElementById(`${agentName}Result`);
            if (statusEl) {
                statusEl.classList.remove('running', 'completed', 'failed');
                statusEl.textContent = status;
                if (status === '运行中') statusEl.classList.add('running');
                if (status === '完成') statusEl.classList.add('completed');
                if (status === '失败') statusEl.classList.add('failed');
            }
            if (resultEl) {
                if (result === undefined || result === null || result === '') {
                    resultEl.classList.remove('has-content');
                    resultEl.textContent = '';
                } else {
                    resultEl.classList.add('has-content');
                    if (typeof result === 'string') {
                        resultEl.textContent = result;
                    } else {
                        try {
                            resultEl.textContent = JSON.stringify(result, null, 2);
                        } catch {
                            resultEl.textContent = String(result);
                        }
                    }
                }
            }
        }

        // 重置所有智能体状态
        function resetAgentsStatus() {
            const agents = ['taskAgent', 'searchAgent', 'chartAgent', 'commentAgent'];
            agents.forEach(a => updateAgentStatus(a, '等待中', '', ''));
            const commentEl = document.getElementById('comment');
            if (commentEl) commentEl.value = '';
            const progressEl = document.getElementById('progress');
            if (progressEl) progressEl.textContent = '';
            const chartEl = document.getElementById('stockChart');
            if (chartEl) {
                chartEl.removeAttribute('src');
                chartEl.setAttribute('alt', '');
            }
        }

        // 生成结果函数
        let es = null;
        function generateResult() {
            // 重置 UI
            resetAgentsStatus();
        
            const progressEl = document.getElementById('progress');
            const userInputEl = document.getElementById('userInput');
        
            // 清理旧错误
            if (userInputEl) {
                userInputEl.classList.remove('error');
                const prevError = userInputEl.parentNode.querySelector('.error-message');
                if (prevError) prevError.remove();
            }
        
            const taskText = (userInputEl?.value || '').trim();
            if (!taskText) {
                showError('userInput', '请输入任务内容');
                return;
            }
        
            // 关闭旧的流
            if (es) {
                try { es.close(); } catch {}
                es = null;
            }
        
            if (progressEl) progressEl.textContent = '正在提交任务...';
            const apiBase = window.location.origin;
        
            // 提交任务
            fetch(`${apiBase}/api/tasks`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ task: taskText })
            })
            .then(async (res) => {
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || `提交任务失败(${res.status})`);
                }
                return res.json();
            })
            .then(({ taskId }) => {
                if (progressEl) progressEl.textContent = '任务已提交，开始接收实时结果...';
        
                // 建立 SSE
                es = new EventSource(`${apiBase}/api/tasks/${taskId}/stream`);
        
                // 任务解析智能体
                es.addEventListener('taskAgent', (e) => {
                    const data = JSON.parse(e.data);
                    updateAgentStatus('taskAgent', '运行中', data.result);
                });
        
                // 搜索智能体
                es.addEventListener('searchAgent', (e) => {
                    const data = JSON.parse(e.data);
                    updateAgentStatus('searchAgent', '运行中', data.result);
                });
        
                // 制图智能体
                es.addEventListener('chartAgent', (e) => {
                    const data = JSON.parse(e.data);
                    updateAgentStatus('chartAgent', '运行中', data.result);
                    const chartEl = document.getElementById('stockChart');
                    if (chartEl) {
                        const v = data.result;
                        if (typeof v === 'string' && (v.startsWith('/') || v.startsWith('http://') || v.startsWith('https://'))) {
                            chartEl.setAttribute('src', v);
                            chartEl.setAttribute('alt', '股票图表');
                        }
                    }
                });
        
                // 评论智能体
                es.addEventListener('commentAgent', (e) => {
                    const data = JSON.parse(e.data);
                    updateAgentStatus('commentAgent', '运行中', data.result);
                    const commentEl = document.getElementById('comment');
                    if (commentEl) {
                        if (typeof data.result === 'string') {
                            commentEl.value = data.result;
                        } else {
                            try {
                                commentEl.value = JSON.stringify(data.result, null, 2);
                            } catch {
                                commentEl.value = String(data.result);
                            }
                        }
                    }
                });
        
                // 完成事件
                es.addEventListener('done', (e) => {
                    updateAgentStatus('taskAgent', '完成', '', '');
                    updateAgentStatus('searchAgent', '完成', '', '');
                    updateAgentStatus('chartAgent', '完成', '', '');
                    updateAgentStatus('commentAgent', '完成', '', '');
                    if (progressEl) progressEl.textContent = '分析完成';
                    try { es.close(); } catch {}
                    es = null;
                });
        
                // 错误处理（服务器断流或网络异常）
                es.onerror = (err) => {
                    updateAgentStatus('taskAgent', '失败', '', '');
                    updateAgentStatus('searchAgent', '失败', '', '');
                    updateAgentStatus('chartAgent', '失败', '', '');
                    updateAgentStatus('commentAgent', '失败', '', '');
                    if (progressEl) progressEl.textContent = '流连接出现错误或中断';
                    try { es.close(); } catch {}
                    es = null;
                };
            })
            .catch((err) => {
                if (progressEl) progressEl.textContent = '';
                showError('userInput', err.message || '请求失败');
            });
        }

            function startSSE(taskId, apiBase) {
                const progressEl = document.getElementById('progress');
                const chartEl = document.getElementById('stockChart');
                const commentEl = document.getElementById('comment');
        
                const url = `${apiBase}/api/tasks/${encodeURIComponent(taskId)}/stream`;
                es = new EventSource(url);
        
                es.addEventListener('open', () => {
                    if (progressEl) progressEl.textContent = '流已连接，等待智能体输出...';
                });
        
                // 任务解析智能体
                es.addEventListener('Task_Analysis_Agent', (ev) => {
                    const payload = safeParse(ev.data);
                    updateAgentStatus('taskAgent', toCNStatus(payload.status), payload.result ?? '');
                });
        
                // 搜索智能体
                es.addEventListener('Search_Agent', (ev) => {
                    const payload = safeParse(ev.data);
                    updateAgentStatus('searchAgent', toCNStatus(payload.status), payload.result ?? '');
                });
        
                // 制图智能体
                es.addEventListener('Plotting_Agent', (ev) => {
                    const payload = safeParse(ev.data);
                    updateAgentStatus('chartAgent', toCNStatus(payload.status), payload.result ?? '');
                    if (payload.imageUrl && chartEl) {
                        chartEl.setAttribute('src', payload.imageUrl);
                        chartEl.setAttribute('alt', '股票图表');
                    }
                });
        
                // 评论智能体（最后一个智能体）
                es.addEventListener('Report_Agent', (ev) => {
                    const payload = safeParse(ev.data);
                    updateAgentStatus('commentAgent', toCNStatus(payload.status), payload.result ?? '');
                    if (commentEl) {
                        // fullComment: 后端聚合的完整评论（推荐）
                        // 若未提供，则回落到 result 字段
                        commentEl.value = payload.fullComment ?? (typeof payload.result === 'string' ? payload.result : JSON.stringify(payload.result ?? '', null, 2));
                    }
                });
        
                // 进度提示
                es.addEventListener('progress', (ev) => {
                    const payload = safeParse(ev.data);
                    if (progressEl) progressEl.textContent = payload.message ?? '';
                });
        
                // 完成收尾
                es.addEventListener('done', (ev) => {
                    const payload = safeParse(ev.data);
                    if (progressEl) progressEl.textContent = payload.message ?? '所有智能体已完成';
                    try { es.close(); } catch {}
                    es = null;
                });
        
                // 通用消息（可选兜底）
                es.addEventListener('message', (ev) => {
                    const payload = safeParse(ev.data);
                    if (payload && payload.agent) {
                        updateAgentStatus(payload.agent, toCNStatus(payload.status), payload.result ?? '');
                    }
                });
        
                es.addEventListener('error', () => {
                    if (progressEl) progressEl.textContent = 'SSE连接错误或已关闭';
                    try { es.close(); } catch {}
                    es = null;
                });
            }
        
        // 安全解析
        function safeParse(data) {
            try { return JSON.parse(data); } catch { return {}; }
        }

        // 状态翻译（后端建议返回 running/completed/failed）
        function toCNStatus(status) {
            switch (status) {
                case 'running': return '运行中';
                case 'completed': return '完成';
                case 'failed': return '失败';
                default: return '等待中';
            }
        }

        // 显示错误消息
        function showError(inputId, message) {
            const input = document.getElementById(inputId);
            input.classList.add('error');
            
            // 检查是否已有错误消息
            if (!input.parentNode.querySelector('.error-message')) {
                const errorEl = document.createElement('div');
                errorEl.className = 'error-message';
                errorEl.textContent = message;
                input.parentNode.appendChild(errorEl);
            }
        }
    </script>
</body>
</html>
